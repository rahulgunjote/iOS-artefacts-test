name: File Upload Download Workflow

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  actions: write
  checks: write
  pull-requests: write

jobs:
  upload_file_1:
    runs-on: macos-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Upload file 1
      uses: actions/upload-artifact@v4
      with:
        name: Test-1
        path: TestResults/Test-1.xcresult

  upload_file_2:
    runs-on: macos-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Create sample file 2
      run: echo "This is file 2 content" > file2.txt
      
    - name: Upload file 2
      uses: actions/upload-artifact@v4
      with:
        name: Test-2
        path: TestResults/Test-2.xcresult
 
  merge-and-process-coverage:
    needs: [upload_file_1, upload_file_2]
    runs-on: macos-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # - name: Install Xcode Command Line Tools
    #   run: |
    #     xcode-select --install

    - name: Install xcresult-merger
      run: |
        brew install xcresult-merger

    - name: Download file 1
      uses: actions/download-artifact@v4
      with:
        name: Test-1
        path: DownloadedTestResults/Test-1.xcresult
        
    - name: Download file 2
      uses: actions/download-artifact@v4
      with:
        name: Test-2
        path: DownloadedTestResults/Test-2.xcresult

    - name: Display file contents
      run: |
        ls -la DownloadedTestResults

    
    - name: Merge xcresult files
      run: |
        xcresult-merger merge --input DownloadedTestResults/Test-1.xcresult --input DownloadedTestResults/Test-2.xcresult --output DownloadedTestResults/merged.xcresult
      # Replace paths with the actual locations of your xcresult files

    - name: Extract Code Coverage Data
      run: |
        xcrun xcresulttool --path DownloadedTestResults/merged.xcresult get --format json > merged_coverage.json
      # The merged coverage data will be saved as JSON

    - name: Upload Code Coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: merged_coverage.json

